{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Incoming Tuition Requests</h2>

  <!-- =============================== -->
  <!-- If there are incoming requests -->
  <!-- =============================== -->
  {% if requests %}
    <div class="row">
      {% for req in requests %}
        <div class="col-md-6">
          <div class="card mb-4 shadow-sm">
            <div class="card-body">

              <!-- Request Header Info -->
              <h5 class="card-title">{{ req.guardian_name }}</h5>
              <p class="card-text">
                <strong>Contact:</strong> {{ req.guardian_contact }}<br>
                <strong>Classes:</strong> {{ req.student_classes }}<br>
                <strong>Subjects:</strong> {{ req.subjects }}<br>
                <strong>Preferred Days:</strong> {{ req.preferred_days or 'N/A' }}<br>
                <strong>Address:</strong> {{ req.address_text or 'N/A' }}<br>
                <strong>Status:</strong> 
                <span class="badge bg-info text-dark">{{ req.status }}</span>
              </p>

              <!-- Action Area (Map Button + Accept/Reject) -->
              <div class="d-flex justify-content-between align-items-center">

                <!-- Show Map -->
                <button 
                  class="btn btn-outline-primary btn-sm"
                  onclick='showCustomMapModal({{ req.latitude }}, {{ req.longitude }}, {{ req.address_text | tojson | safe }})'>
                    <i class="bi bi-map"></i> View Map
                </button>

                <!-- Accept/Reject Form -->
                <form method="post" action="{{ url_for('respond_tutor_request') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="request_id" value="{{ req.id }}">
                  <button name="action" value="accept" class="btn btn-success btn-sm">Accept</button>
                  <button name="action" value="reject" class="btn btn-danger btn-sm">Reject</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- =============================== -->
        <!-- Custom Location Modal -->
        <!-- (Displays Leaflet Map of location) -->
        <!-- =============================== -->
        <div id="customMapModal" class="custom-modal-overlay" onclick="hideCustomMapModal(event)">
          <div class="custom-modal-content" onclick="event.stopPropagation()">
            <span class="custom-modal-close" onclick="hideCustomMapModal()">&times;</span>
            <h5>Location on Map</h5>
            <div id="customMap" style="height: 400px;"></div>
          </div>
        </div>

      {% endfor %}
    </div>
  {% else %}
    <!-- No Requests Found -->
    <div class="alert alert-info">
      You have no tutor requests at the moment.
    </div>
  {% endif %}
</div>

<!-- =============================== -->
<!-- Scripts Section -->
<!-- =============================== -->
{% block scripts %}
<script>
  let customMapInstance = null;

  // =============================
  // Show Map Modal with Leaflet
  // =============================
  function showCustomMapModal(lat, lng, title = "Selected Location") {
    console.log(`Showing map for coordinates: ${lat}, ${lng}`);
    const modal = document.getElementById('customMapModal');
    modal.style.display = 'block';

    // Delay ensures map container available in DOM
    setTimeout(() => {
      const mapContainer = document.getElementById('customMap');

      // Destroy previous map instance if exists
      if (customMapInstance) {
        customMapInstance.remove();
      }

      // Create new Leaflet map centered on given coords
      customMapInstance = L.map(mapContainer).setView([lat, lng], 14);

      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(customMapInstance);

      // Add marker with popup
      L.marker([lat, lng]).addTo(customMapInstance).bindPopup(title).openPopup();
    }, 100);
  }

  // =============================
  // Hide Map Modal
  // =============================
  function hideCustomMapModal() {
    const modal = document.getElementById('customMapModal');
    modal.style.display = 'none';

    // Remove active map instance
    if (customMapInstance) {
      customMapInstance.remove();
      customMapInstance = null;
    }
  }
</script>
{% endblock %}

<!-- =============================== -->
<!-- Custom Modal CSS -->
<!-- =============================== -->
<style>
  .leaflet-map-container {
    height: 400px;
    width: 100%;
  }
</style>

{% endblock %}
