<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <title>Tuition Finder</title>
    <!-- jQuery and Bootstrap JS (required) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap 5 (optional if already loaded elsewhere) -->
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body id="body">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">

        <!-- Brand -->
        <a class="navbar-brand" href="{{ url_for('home') }}">Tuition Finder</a>

        

        <!-- Collapsible nav links -->
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav ms-auto">
            {% if current_user.is_authenticated %}
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
              </li>
              {% if current_user.is_admin %}
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a>
                </li>
              {% endif %}
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
              </li>
            {% else %}
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('login') }}">Login</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('register') }}">Register</a>
              </li>
            {% endif %}
          </ul>
        </div>
        
        <!-- Right icons (Notification + Dark mode) -->
        <div class="d-flex align-items-center ms-auto">

          {% if current_user.is_authenticated %}
            <!-- Notification -->
            <div class="nav-item dropdown me-3">
              <a class="nav-link position-relative text-white" href="#" id="notificationDropdown"
                role="button" data-bs-toggle="dropdown" aria-expanded="false">
                ðŸ””
                <span class="badge bg-danger" id="notif-count">
                  {{ all_notifications | selectattr("is_read", "equalto", False) | list | length }}
                </span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" id="notif-menu"
                  style="max-height: 300px; overflow-y: auto;">
                {% if all_notifications|length == 0 %}
                  <li id="no-notif-msg">
                    <span class="dropdown-item text-muted">No notifications</span>
                  </li>
                {% else %}
                  {% for notif in all_notifications %}
                    <li>
                      <a href="#" class="dropdown-item {% if not notif.is_read %}fw-bold text-dark{% else %}text-muted{% endif %}"
                        data-id="{{ notif.id }}" data-link="{{ notif.link }}"
                        onclick="handleNotificationClickAttr(event, this)">
                        {{ notif.message }}
                      </a>
                    </li>
                  {% endfor %}
                {% endif %}
              </ul>
            </div>
          {% endif %}

          <!-- Dark mode toggle -->
          <div class="nav-item me-2">
            <button id="darkModeToggle" class="btn btn-outline-light border-0" style="font-size: 1.3rem;" title="Toggle Dark Mode">
              ðŸŒ™
            </button>
          </div>
          <!-- Toggler button (mobile only) -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarContent" aria-controls="navbarContent"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        </div>

      </div>
    </nav>


    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    

    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
function handleNotificationClickAttr(event, el) {
  event.preventDefault();
  const id = el.getAttribute('data-id');
  const link = el.getAttribute('data-link');
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  fetch(`/mark_notification_read/${id}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    }
  }).then(() => {
    const badge = document.getElementById("notif-count");
    let count = parseInt(badge.textContent);
    if (!isNaN(count) && count > 0) {
      badge.textContent = count - 1;
      if (count - 1 === 0) badge.classList.add('d-none');
    }
    window.location.href = link;
  });
}


function handleNotificationClick(event, id, link) {
  event.preventDefault();

  fetch(`/mark_notification_read/${id}`, { method: 'POST' })
    .then(() => {
      const badge = document.getElementById("notif-count");
      let count = parseInt(badge.textContent);
      if (!isNaN(count) && count > 0) {
        badge.textContent = count - 1;
        if (count - 1 === 0) badge.classList.add('d-none');
      }
      window.location.href = link;
    });
}

const socket = io();

socket.on("connect", () => {
  {% if current_user.is_authenticated %}
    socket.emit("join", { user_id: {{ current_user.id }} });
  {% endif %}
});

socket.on("new_notification", function (data) {
  const notifMenu = document.getElementById("notif-menu");
  const notifCount = document.getElementById("notif-count");

  const noNotifMsg = document.getElementById("no-notif-msg");
  if (noNotifMsg) noNotifMsg.remove();

  const notifItem = document.createElement("li");
  const notifLink = document.createElement("a");
  notifLink.href = "#";
  notifLink.className = "dropdown-item fw-bold text-dark";
  notifLink.textContent = data.message;
  notifLink.onclick = function (e) {
  e.preventDefault();
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  fetch(`/mark_notification_read/${data.id}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    }
  }).then(() => window.location.href = data.link);
};


  notifItem.appendChild(notifLink);
  notifMenu.prepend(notifItem);

  const newCount = parseInt(notifCount.textContent) || 0;
  notifCount.textContent = newCount + 1;
  notifCount.classList.remove("d-none");
});
</script>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet/dist/leaflet.css"
/>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet/dist/leaflet.js"
></script>

</body>
</html>
