<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <link rel="icon" href="{{ url_for('static', filename='images/tutorlinkbd-logo.png') }}" type="image/png">
  <title>TutorLink BD</title>

  <!-- jQuery and Bootstrap JS (required) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- Leaflet Map CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body id="body">
  <!-- =============================== -->
  <!-- Navigation Bar -->
  <!-- =============================== -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">

      <!-- Brand with logo and link -->
      <a class="navbar-brand" href="{{ url_for('home') }}">
        <img src="{{ url_for('static', filename='images/tutorlinkbd-logo.png') }}" 
             alt="TutorLink BD Logo" 
             style="height: 40px; margin-right: 10px; vertical-align: middle;">
        TutorLink BD
      </a>

      <!-- Collapsible nav links -->
      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav ms-auto">
          {% if current_user.is_authenticated %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
            </li>
            {% if current_user.is_admin %}
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a>
              </li>
            {% endif %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('login') }}">Login</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('register') }}">Register</a>
            </li>
          {% endif %}
        </ul>
      </div>

      <!-- Right icons (Chat + Notifications + Dark Mode) -->
      <div class="d-flex align-items-center ms-auto">

        {% if current_user.is_authenticated %}
          <!-- Chat Dropdown -->
          <div class="nav-item dropdown me-3">
            <a class="nav-link position-relative text-white" href="#" id="chatDropdown"
               role="button" data-bs-toggle="dropdown" aria-expanded="false">
              ðŸ’¬
              <span class="badge bg-danger" id="chat-count">0</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end notif-dropdown" id="chat-menu">
              <li>
                <span class="dropdown-item text-muted" style="color: var(--text-color) !important;">
                  No recent chats
                </span>
              </li>
            </ul>
          </div>

          <!-- Notifications Dropdown -->
          <div class="nav-item dropdown me-3">
            <a class="nav-link position-relative text-white" href="#" id="notificationDropdown"
               role="button" data-bs-toggle="dropdown" aria-expanded="false">
              ðŸ””
              <span class="badge bg-danger" id="notif-count">
                {{ all_notifications | selectattr("is_read", "equalto", False) | list | length }}
              </span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end notif-dropdown" id="notif-menu">
              {% if all_notifications|length == 0 %}
                <li id="no-notif-msg">
                  <span class="dropdown-item text-muted">No notifications</span>
                </li>
              {% else %}
                {% for notif in all_notifications %}
                <li class="notif-item {% if not notif.is_read %}unread{% endif %}">
                  <a href="#"
                     class="dropdown-item d-flex align-items-start"
                     data-id="{{ notif.id }}" 
                     data-link="{{ notif.link }}"
                     onclick="handleNotificationClickAttr(event, this)">
                    
                    <!-- Avatar -->
                    <img src="{{ url_for('static', filename='uploads/' + notif.user.profile_picture) if notif.user and notif.user.profile_picture else url_for('static', filename='uploads/default.jpg') }}" 
                         class="rounded-circle me-2 notif-avatar" 
                         alt="{{ notif.user.username if notif.user else 'Default User' }}"
                         onerror="this.onerror=null; this.src='{{ url_for('static', filename='uploads/default.jpg') }}';">
                    
                    <!-- Message + Timestamp -->
                    <div class="notif-content flex-grow-1">
                      <div class="notif-message">{{ notif.message }}</div>
                      <small class="notif-time">{{ notif.timestamp.strftime('%b %d, %Y %I:%M %p') }}</small>
                    </div>
                  </a>
                </li>
                {% endfor %}
              {% endif %}
            </ul>
          </div>
        {% endif %}

        <!-- Dark mode toggle -->
        <div class="nav-item me-2">
          <button id="darkModeToggle" class="btn btn-outline-light border-0" style="font-size: 1.3rem;" title="Toggle Dark Mode">
            ðŸŒ™
          </button>
        </div>

        <!-- Navbar toggler button (for mobile view) -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarContent" aria-controls="navbarContent"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

      </div> <!-- end .d-flex -->
    </div> <!-- end .container-fluid -->
  </nav>

  <!-- =============================== -->
  <!-- Page Content + Flash Messages -->
  <!-- =============================== -->
  <div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>

  <!-- =============================== -->
  <!-- JS Includes -->
  <!-- =============================== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
  /* ======================================================
     Handle Notification Click (mark as read + redirect)
     ====================================================== */
  function handleNotificationClickAttr(event, el) {
    event.preventDefault();
    const id = el.getAttribute('data-id');
    const link = el.getAttribute('data-link');

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/mark_notification_read/${id}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    }).then(() => {
      const badge = document.getElementById("notif-count");
      let count = parseInt(badge.textContent);
      if (!isNaN(count) && count > 0) {
        badge.textContent = count - 1;
        if (count - 1 === 0) badge.classList.add('d-none');
      }
      window.location.href = link;
    });
  }

  /* ======================================================
     Socket.IO Connection
     ====================================================== */
  const socket = io();

  socket.on("connect", () => {
    {% if current_user.is_authenticated %}
      socket.emit("join", { user_id: {{ current_user.id }} });
    {% endif %}
  });

  /* ======================================================
     New Notification from Socket
     ====================================================== */
  socket.on("new_notification", function (data) {
    const notifMenu = document.getElementById("notif-menu");
    const notifCount = document.getElementById("notif-count");
    const noNotifMsg = document.getElementById("no-notif-msg");
    if (noNotifMsg) noNotifMsg.remove();

    const notifItem = document.createElement("li");
    notifItem.className = "notif-item unread";

    notifItem.innerHTML = `
      <a href="#" class="dropdown-item d-flex align-items-start" 
         data-id="${data.id}" data-link="${data.link}"
         onclick="handleNotificationClickAttr(event, this)">
        <img src="${data.sender_avatar || '/static/uploads/default.jpg'}" 
             class="rounded-circle me-2 notif-avatar" 
             alt="${data.sender_name ? data.sender_name + '\'s Profile Picture' : 'Default User'}"
             onerror="this.onerror=null; this.src='/static/uploads/default.jpg';">
        <div class="notif-content flex-grow-1">
          <div class="notif-message">${data.message}</div>
          <small class="notif-time">${data.timestamp}</small>
        </div>
      </a>
    `;
    notifMenu.prepend(notifItem);

    const newCount = parseInt(notifCount.textContent) || 0;
    notifCount.textContent = newCount + 1;
    notifCount.classList.remove("d-none");
  });

  /* ======================================================
     Chat System Logic
     ====================================================== */
  let currentChatUser = null;

  // Open chat modal and load history
  function openChat(userId, username) {
    currentChatUser = userId;
    document.getElementById("chatModalTitle").textContent = `Chat with ${username}`;
    $("#chatModal").modal("show");

    fetch(`/chat_history/${userId}`)
      .then(res => res.json())
      .then(data => {
        const chatBox = document.getElementById("chatMessages");
        chatBox.innerHTML = "";
        if (data.length === 0) showNoMessages();
        else data.forEach(msg => appendMessage(msg));
      })
      .then(() => {
        // Mark messages as read after opening
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/mark_chat_read/${userId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken }
        }).then(() => {
          const chatCount = document.getElementById("chat-count");
          let current = parseInt(chatCount.textContent) || 0;
          if (current > 0) {
            updateChatDropdown();
            // Sync badge with backend
            fetch('/get_unread_count')
              .then(res => res.json())
              .then(d => {
                chatCount.textContent = d.chat_unread || 0;
              });
          }
        });
      });
  }

  // Append a chat message box
  function appendMessage(msg) {
    const chatBox = document.getElementById("chatMessages");
    const isMine = msg.sender_id == {{ current_user.id }};

    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.marginBottom = "8px";
    wrapper.style.justifyContent = isMine ? "flex-end" : "flex-start";

    const msgDiv = document.createElement("div");
    msgDiv.className = isMine ? "chat-message-mine" : "chat-message-their";
    msgDiv.style.maxWidth = "75%";

    let html = "";
    if (msg.message) html += msg.message;
    if (msg.image_path) {
      html += `<img src="${msg.image_path}" class="img-fluid mt-1 rounded" style="max-width:160px; display:block;">`;
    }

    // Convert UTC timestamp â†’ UTC+6
    let date = new Date(msg.timestamp);
    date.setHours(date.getHours() + 6);
    let localTime = date.toLocaleString("en-GB", { 
      dateStyle: "short", 
      timeStyle: "short",
      hour12: true
    });

    html += `<div style="font-size:0.77em; color:#800; margin-top:3px;">${localTime}</div>`;



    msgDiv.innerHTML = html;
    wrapper.appendChild(msgDiv);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // Send a chat message
  function sendChatMessage() {
    const text = document.getElementById("chatInput").value;
    const imgInput = document.getElementById("chatImage");
    let imagePath = null;
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    if (imgInput.files.length > 0) {
      const formData = new FormData();
      formData.append('image', imgInput.files[0]);
      fetch('/upload_chat_image', { 
        method: 'POST', 
        headers: { 'X-CSRFToken': csrfToken }, 
        body: formData 
      })
        .then(res => res.json())
        .then(data => {
          imagePath = data.path;
          socket.emit('send_message', {
            sender_id: {{ current_user.id }},
            receiver_id: currentChatUser,
            message: text,
            image_path: imagePath
          });
        });
    } else {
      socket.emit('send_message', {
        sender_id: {{ current_user.id }},
        receiver_id: currentChatUser,
        message: text
      });
    }
    document.getElementById("chatInput").value = "";
    clearImagePreview();
    imgInput.value = "";
  }

  // Handle receiving messages
  socket.on("receive_message", function (msg) {
    if ($("#chatModal").hasClass("show")
      && currentChatUser
      && (msg.sender_id == currentChatUser || msg.receiver_id == currentChatUser)) {
      appendMessage(msg);
      document.getElementById("chatMessages").scrollTop = document.getElementById("chatMessages").scrollHeight;

      fetch(`/mark_chat_read/${msg.sender_id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').getAttribute("content") },
        credentials: "same-origin"
      });
      updateChatDropdown();
    } else {
      const chatCount = document.getElementById("chat-count");
      chatCount.textContent = parseInt(chatCount.textContent) + 1;
      updateChatDropdown();
    }
  });

  /* ======================================================
     DOM Ready Setup
     ====================================================== */
  document.addEventListener('DOMContentLoaded', function () {
    // Load chat preview dropdown
    fetch('/inject_chats')
      .then(res => res.json())
      .then(data => {
        const chatMenu = document.getElementById("chat-menu");
        chatMenu.innerHTML = "";
        if (data.length === 0) {
          chatMenu.innerHTML = '<li><span class="dropdown-item text-muted">No recent chats</span></li>';
        } else {
          data.forEach(chat => {
            chatMenu.innerHTML += `
              <li>
                <a class="dropdown-item chat-dropdown-item chat-btn d-flex align-items-center"
                   data-tutor-id="${chat.user_id}" data-name="${chat.username}" href="#">
                  <img src="/static/uploads/${chat.profile_pic ? chat.profile_pic : 'default.jpg'}"
                       class="rounded-circle me-2"
                       style="width:32px;height:32px;object-fit:cover;"
                       alt="${chat.username ? chat.username + '\'s Profile Picture' : 'Default Profile Picture'}"
                       onerror="this.onerror=null; this.src='/static/uploads/default.jpg';">
                  <div class="flex-grow-1">
                    <div class="${chat.unread_count > 0 ? 'unread-chat' : ''}">${chat.username}</div>
                    <div class="text-muted small">${chat.preview || ''}</div>
                  </div>
                </a>
              </li>`;
          });
        }
      });

    // Setup image picker
    const imagePickerBtn = document.getElementById('imagePickerBtn');
    if (imagePickerBtn) {
      imagePickerBtn.onclick = () => document.getElementById('chatImage').click();
    }

    // Setup image preview
    const chatImage = document.getElementById('chatImage');
    if (chatImage) {
      chatImage.addEventListener('change', function (e) {
        const file = e.target.files[0];
        const preview = document.getElementById('chatImagePreview');
        if (file) {
          const reader = new FileReader();
          reader.onload = function (ev) {
            preview.src = ev.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = '';
          preview.style.display = 'none';
        }
      });
    }

    // Send button
    const sendBtn = document.getElementById('chatSendBtn');
    if (sendBtn) sendBtn.onclick = sendChatMessage;

    // Enter key sends message
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
      chatInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (sendBtn) sendBtn.click();
        }
      });
    }
  });

  /* ======================================================
     Other Utility Functions
     ====================================================== */

  // Delegate: open chat modal
  document.addEventListener('click', function(e) {
    const chatBtn = e.target.closest('.chat-btn');
    if (chatBtn) {
      e.preventDefault();
      const tutorId = chatBtn.getAttribute('data-tutor-id');
      const tutorName = chatBtn.getAttribute('data-name');
      openChat(tutorId, tutorName);
    }
  });

  // Duplicate listener (also opens modal)
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('chat-btn')) {
      const tutorId = e.target.getAttribute('data-tutor-id');
      const tutorName = e.target.getAttribute('data-name');
      openChat(tutorId, tutorName);
    }
  });

  // Update chat dropdown list
  function updateChatDropdown() {
    fetch('/inject_chats')
      .then(res => res.json())
      .then(data => {
        const chatMenu = document.getElementById("chat-menu");
        chatMenu.innerHTML = "";
        if (data.length === 0) {
          chatMenu.innerHTML = '<li><span class="dropdown-item text-muted">No recent chats</span></li>';
        } else {
          data.forEach(chat => {
            chatMenu.innerHTML += `
              <li>
                <a class="dropdown-item chat-dropdown-item chat-btn d-flex align-items-center ${chat.unread_count > 0 ? 'unread-chat' : ''}"
                   data-tutor-id="${chat.user_id}" data-name="${chat.username}" href="#">
                  <img src="/static/uploads/${chat.profile_pic ? chat.profile_pic : 'default.jpg'}"
                       class="rounded-circle me-2"
                       style="width:32px;height:32px;object-fit:cover;"
                       alt="${chat.username ? chat.username + '\'s Profile Picture' : 'Default Profile Picture'}"
                       onerror="this.onerror=null; this.src='/static/uploads/default.jpg';">
                  <div class="flex-grow-1">
                    <div>${chat.username}</div>
                    <div class="text-muted small">${chat.preview || ''}</div>
                  </div>
                </a>
              </li>`;
          });
        }
      });
  }

  // Clear chat image preview
  document.addEventListener('DOMContentLoaded', function () {
    const chatImage = document.getElementById('chatImage');
    const preview = document.getElementById('chatImagePreview');
    const xBtn = document.getElementById('chatImagePreviewRemove');

    chatImage.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (ev) {
          preview.src = ev.target.result;
          preview.style.display = 'block';
          xBtn.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        clearImagePreview();
      }
    });

    xBtn.onclick = clearImagePreview;
  });

  // Utility: clear preview box
  function clearImagePreview() {
    const preview = document.getElementById("chatImagePreview");
    if (preview) {
      preview.style.display = "none";
      preview.src = "";
    }
    const chatImage = document.getElementById("chatImage");
    if (chatImage) chatImage.value = "";
    const xBtn = document.getElementById("chatImagePreviewRemove");
    if (xBtn) xBtn.style.display = "none";
  }

  // Utility: show "no messages yet"
  function showNoMessages() {
    const chatBox = document.getElementById("chatMessages");
    chatBox.innerHTML = '<div class="no-messages">No messages yet.</div>';
  }
</script>

<!-- ======================================================
     Chat Modal (Bootstrap)
     ====================================================== -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog chat-fb-dialog">
    <div class="modal-content chat-fb-content">

      <!-- Header -->
      <div class="modal-header chat-fb-header">
        <h5 class="modal-title" id="chatModalTitle">Chat</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Chat Body -->
      <div class="modal-body chat-fb-body" id="chatMessages">
        <!-- Messages will appear here -->
      </div>

      <!-- Footer (input + buttons) -->
      <div class="modal-footer chat-fb-footer">
        <input type="file" id="chatImage" style="display:none;">
        <button class="btn btn-sm btn-light" id="imagePickerBtn">
          <span>ðŸ“·</span>
        </button>
        
        <div style="flex:1; position:relative">
          <input type="text" id="chatInput" class="form-control" placeholder="Type a message">
          <img id="chatImagePreview" style="display:none; position: absolute; right:28px; top:-55px; 
               z-index:10; max-height:50px; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.12);">
          <button id="chatImagePreviewRemove" type="button" 
                  style="display:none; position:absolute; right:4px; top:-55px; z-index:11; 
                         background:rgba(0,0,0,0.56); color:#fff; border:none; border-radius:50%; 
                         width:22px; height:22px; cursor:pointer; font-size:14px; line-height:1;"
                  aria-label="Remove image">&times;</button>
        </div>

        <button class="btn btn-primary" id="chatSendBtn">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- ======================================================
     Leaflet Map (CSS + JS)
     ====================================================== -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</body>
</html>

