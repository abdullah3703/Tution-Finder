{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <!-- Profile Card -->
    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          {% if current_user.profile_picture %}
            <img src="{{ url_for('static', filename='uploads/' + current_user.profile_picture) }}"
                 class="rounded-circle mb-3" width="100" height="100" alt="Profile Picture">
          {% else %}
            <img src="{{ url_for('static', filename='default-avatar.png') }}"
                 class="rounded-circle mb-3" width="100" height="100" alt="Default Picture">
          {% endif %}
          <h5 class="card-title">{{ user.username }}</h5>
          <p class="card-text text-muted">{{ user.role | capitalize }}</p>
          <a href="{{ url_for('update_profile') }}" class="btn btn-outline-primary btn-sm">Edit Profile</a>
        </div>
      </div>
    </div>

    <!-- Activity & Actions -->
    <div class="col-md-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <strong>Account Overview</strong>
        </div>
        <div class="card-body">
          {% if user.role == 'tutor' %}
            <p class="mb-1">You can apply for tuition jobs near your location.</p>
            <p>Status: 
              {% if user.is_seeking_tuition %}
                <span class="badge bg-success">Actively Seeking Tuition</span>
              {% else %}
                <span class="badge bg-secondary">Not Available</span>
              {% endif %}
            </p>
          {% elif user.role == 'guardian' %}
            <p class="mb-1">You can post your tuition needs and browse tutors.</p>
            <a href="{{ url_for('tutor_request') }}" class="btn btn-primary">Create Tutor Request</a>
          {% endif %}
        </div>
      </div>

      <!-- Search Tutor Block -->
      {% if user.role == 'guardian' %}
      <div class="card shadow-sm">
        <div class="card-header">
          <strong>Find a Tutor</strong>
        </div>
        <div class="card-body">
          <form id="searchForm">
            <div class="row g-2 mb-2">
              <div class="col-md-4">
                <label class="form-label">Division</label>
                <select name="division_id" id="division" class="form-select">
                  <option value="">All Divisions</option>
                  {% for div in divisions %}
                    <option value="{{ div.id }}">{{ div.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">District</label>
                <select name="district_id" id="district" class="form-select">
                  <option value="">All Districts</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Upazila</label>
                <select name="upazila_id" id="upazila" class="form-select">
                  <option value="">All Upazilas</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mb-2">
              <div class="col-md-6">
                <label class="form-label">Available Day</label>
                <select id="available_day" name="day" class="form-select" multiple="multiple">
                  <option value="Any" selected>Any</option>
                  <option value="Saturday">Saturday</option>
                  <option value="Sunday">Sunday</option>
                  <option value="Monday">Monday</option>
                  <option value="Tuesday">Tuesday</option>
                  <option value="Wednesday">Wednesday</option>
                  <option value="Thursday">Thursday</option>
                  <option value="Friday">Friday</option>
                </select>
              </div>

              <div class="row g-2 mb-2">
                <div class="col-md-6">
                  <label class="form-label">Preferred Classes</label>
                  <select name="preferred_classes" class="form-select" multiple id="class-select">
                    <option value="KG">KG</option>
                    <option value="Class 1">Class 1</option>
                    <option value="Class 2">Class 2</option>
                    <option value="Class 3">Class 3</option>
                    <option value="Class 4">Class 4</option>
                    <option value="Class 5">Class 5</option>
                    <option value="Class 6">Class 6</option>
                    <option value="Class 7">Class 7</option>
                    <option value="Class 8">Class 8</option>
                    <option value="Class 9">Class 9</option>
                    <option value="Class 10">Class 10</option>
                    <option value="Class 11">Class 11</option>
                    <option value="Class 12">Class 12</option>
                    <option value="O Level">O Level</option>
                    <!-- Add more classes -->
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Subjects</label>
                  <select name="subjects" class="form-select" multiple id="subject-select">
                    <option value="Math">Math</option>
                    <option value="English">English</option>
                    <option value="Physics">Physics</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Biology">Biology</option>
                    <option value="Bangla">Bangla</option>
                    <option value="History">History</option>
                    <option value="Geography">Geography</option>
                    <option value="ICT">ICT</option>
                    <option value="Accounting">Accounting</option>
                    <option value="Economics">Economics</option>
                    <option value="Business Studies">Business Studies</option>
                    <option value="Statistics">Statistics</option>
                    <option value="Psychology">Psychology</option>
                    <option value="Sociology">Sociology</option>
                    <option value="Arts">Arts</option>
                    <option value="Music">Music</option>
                    <option value="Physical Education">Physical Education</option>

                    <!-- Add more subjects -->
                  </select>
                </div>
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">Search</button>
              </div>
            </div>
          </form>

          <div id="tutorResults" class="mt-4 row">
            <!-- Results go here -->
          </div>
        </div>
      </div>
      {% endif %}
      {% if user.role == 'tutor' %}
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <strong>Find Tuition Requests</strong>
        </div>
        <div class="card-body">
          <form id="tuitionSearchForm">
            <div class="row g-2 mb-2">
              <div class="col-md-4">
                <label class="form-label">Division</label>
                <select name="division_id" id="tuition-division" class="form-select">
                  <option value="">All Divisions</option>
                  {% for div in divisions %}
                    <option value="{{ div.id }}">{{ div.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">District</label>
                <select name="district_id" id="tuition-district" class="form-select">
                  <option value="">All Districts</option>
                </select>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">Search</button>
              </div>
            </div>
          </form>
          <div id="tuitionResults" class="mt-3 row"></div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- Tutor Profile Modal -->
<div class="modal fade" id="tutorProfileModal" tabindex="-1" role="dialog" aria-labelledby="tutorProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="background-color: var(--card-bg); color: var(--text-color);">
      <div class="modal-header border-bottom" style="border-color: var(--card-border);">
        <h5 class="modal-title" id="tutorProfileModalLabel">Tutor Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(0);"></button>
      </div>
      <div class="modal-body" id="tutorProfileContent">
        <p>Loading...</p>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
  $('#available_day').select2({
    placeholder: "Select available day(s)",
    allowClear: true,
  });

  // Ensure only "Any" OR specific days are selected
  $('#available_day').on('change', function () {
    const selected = $(this).val();

    if (selected && selected.includes('Any') && selected.length > 1) {
      // If "Any" is selected along with others, remove others
      $(this).val(['Any']).trigger('change');
    } else if (selected && !selected.includes('Any') && selected.length > 0) {
      // If any other selected, remove "Any" if previously selected
      const filtered = selected.filter(v => v !== 'Any');
      $(this).val(filtered).trigger('change');
    }
  });
});

  $(document).ready(function () {
    // Initialize Select2 on the multiselect dropdowns
    $('#class-select, #subject-select').select2({
      placeholder: "Select options",
      allowClear: true,
      width: '100%'
    });

    // Handle cascading district/upazila loading
    $('#division').on('change', function () {
      const divisionId = $(this).val();
      $('#district').html('<option value="">Loading...</option>');
      $('#upazila').html('<option value="">All Upazilas</option>');
      if (divisionId) {
        fetch(`/districts/${divisionId}`)
          .then(res => res.json())
          .then(data => {
            $('#district').html('<option value="">All Districts</option>');
            data.forEach(([id, name]) => {
              $('#district').append(`<option value="${id}">${name}</option>`);
            });
          });
      } else {
        $('#district').html('<option value="">All Districts</option>');
      }
    });

    $('#district').on('change', function () {
      const districtId = $(this).val();
      $('#upazila').html('<option value="">Loading...</option>');
      if (districtId) {
        fetch(`/upazilas/${districtId}`)
          .then(res => res.json())
          .then(data => {
            $('#upazila').html('<option value="">All Upazilas</option>');
            data.forEach(([id, name]) => {
              $('#upazila').append(`<option value="${id}">${name}</option>`);
            });
          });
      } else {
        $('#upazila').html('<option value="">All Upazilas</option>');
      }
    });

    // Tutor search submit handler
    $('#searchForm').on('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const params = new URLSearchParams();
      formData.forEach((value, key) => {
        params.append(key, value);
      });

      // Handle multiple values from Select2 manually
      $('#class-select').val()?.forEach(val => params.append('preferred_classes', val));
      $('#subject-select').val()?.forEach(val => params.append('subjects', val));

      fetch(`/api/search_tutors?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('tutorResults');
          container.innerHTML = '';
          if (data.length === 0) {
            container.innerHTML = '<p class="text-muted">No tutors found for selected filters.</p>';
            return;
          }
          data.forEach(tutor => {
            container.innerHTML += `
              <div class="col-md-6 mb-3">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                      ${tutor.profile_picture ? `<img src="${tutor.profile_picture}" class="rounded-circle me-3" width="60">` : ''}
                      <div>
                        <h5 class="mb-0">${tutor.name}</h5>
                        <small class="text-muted">${tutor.division || ''}, ${tutor.district || ''}, ${tutor.upazila || ''}</small>
                      </div>
                    </div>
                    <p><strong>Subjects:</strong> ${tutor.subjects || 'N/A'}</p>
                    <p><strong>Time Slots:</strong> ${tutor.time_slots || 'N/A'}</p>
                    <p><strong>Available Days:</strong> ${tutor.available_days || 'N/A'}</p>
                    <p><strong>Expected Salary:</strong> ${tutor.salary_expectation || 'N/A'}</p>
                    <button class="btn btn-primary view-profile-btn" data-id="${tutor.id}">View Profile</button>
                  </div>
                </div>
              </div>
            `;
          });
        });
    });
  });
document.addEventListener('click', function (event) {
  if (event.target.classList.contains('view-profile-btn')) {
    const tutorId = event.target.getAttribute('data-id');
    fetch(`/api/tutor/${tutorId}`)
      .then(response => response.json())
      .then(tutor => {
        const profilePicture = tutor.profile_picture 
          ? tutor.profile_picture
          : '{{ url_for("static", filename="default-avatar.png") }}';

        const content = `
          <div class="row">
            <div class="col-md-4 text-center">
              <img src="${profilePicture}" alt="Profile Picture" class="img-fluid rounded-circle mb-3 border shadow" style="max-width: 180px;">
              <h5>${tutor.username}</h5>
              <p class="text-muted">${tutor.gender}</p>
            </div>
            <div class="col-md-8">
              <p><strong>Email:</strong> ${tutor.email}</p>
              <p><strong>Phone:</strong> ${tutor.phone}</p>
              <p><strong>Address:</strong> ${tutor.upazila}, ${tutor.district}, ${tutor.division}</p>
              <p><strong>Preferred Classes:</strong> ${tutor.preferred_classes}</p>
              <hr>
              <h6>Educational Qualifications</h6>

              <div class="mb-3">
                <strong>SSC:</strong>
                <p>Institute: ${tutor.ssc.institute}</p>
                <p>Result: ${tutor.ssc.result}</p>
                <p>Group: ${tutor.ssc.group}</p>
                
              </div>

              <div class="mb-3">
                <strong>HSC:</strong>
                <p>Institute: ${tutor.hsc.institute}</p>
                <p>Result: ${tutor.hsc.result}</p>
                <p>Group: ${tutor.hsc.group}</p>
                
              </div>

              <div class="mb-3">
                <strong>Graduation:</strong>
                <p>Institute: ${tutor.graduation.institute}</p>
                <p>Result: ${tutor.graduation.result}</p>
                <p>Group: ${tutor.graduation.group}</p>
                
              </div>
            </div>
          </div>
        `;
        document.getElementById('tutorProfileContent').innerHTML = content;
        const profileModal = new bootstrap.Modal(document.getElementById('tutorProfileModal'));
        profileModal.show();
      });
  }
});

// Load districts when division changes
$('#tuition-division').on('change', function () {
  const divisionId = $(this).val();
  $('#tuition-district').html('<option value="">Loading...</option>');
  if (divisionId) {
    fetch(`/districts/${divisionId}`)
      .then(res => res.json())
      .then(data => {
        $('#tuition-district').html('<option value="">All Districts</option>');
        data.forEach(([id, name]) => {
          $('#tuition-district').append(`<option value="${id}">${name}</option>`);
        });
      });
  } else {
    $('#tuition-district').html('<option value="">All Districts</option>');
  }
});

// Search tuition requests
$('#tuitionSearchForm').on('submit', function (e) {
  e.preventDefault();
  const params = new URLSearchParams(new FormData(this)).toString();
  fetch(`/api/search_tuition_requests?${params}`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('tuitionResults');
      container.innerHTML = '';
      if (data.length === 0) {
        container.innerHTML = '<p class="text-muted">No tuition requests found.</p>';
        return;
      }
      data.forEach(req => {
        container.innerHTML += `
          <div class="col-md-6 mb-3">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">${req.subjects}</h5>
                <p><strong>Classes:</strong> ${req.student_classes}</p>
                <p><strong>Preferred Days:</strong> ${req.preferred_days}</p>
                <p><strong>Salary:</strong> ${req.salary || 'Not specified'}</p>
                <p><strong>Time:</strong> ${req.teaching_time || 'Not specified'}</p>
                <p><strong>Location:</strong> ${req.address_text || req.district}</p>
                <p><strong>Gender Preference:</strong> ${req.preferred_tutor_gender}</p>
              </div>
            </div>
          </div>
        `;
      });
    });
});


</script>



{% endblock %}
